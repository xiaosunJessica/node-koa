<script setup lang='ts'>
import _ from 'lodash'
import cookie from 'cookie'
import { defineProps, reactive, type StyleHTMLAttributes, computed, ref, getCurrentInstance, onMounted, onBeforeDestroy } from 'vue';

const CACHE_KEY = 'lesscode_supermen'
const wraperRef = ref();
const tipRef = ref();
const helpImg = new URL('./help.png', import.meta.url).href;
window.__lesscodeEditPageGuide = getCurrentInstance()
const props = defineProps({
  data: {
    type: Array,
    required: true
  }
})

const state = reactive<{
  isShowFinisheDialog: boolean,
  isShowStopDialog: boolean,
  // eslint-disable-next-line no-prototype-builtins
  isDone: boolean,
  currentStepIndex: number,
  currentStep: any,
  tipStyles: StyleHTMLAttributes ,
  placement: string,
  doneCountTime: number
}>({
  isShowFinisheDialog: false,
  isShowStopDialog: false,
  // eslint-disable-next-line no-prototype-builtins
  isDone: cookie.parse(document.cookie).hasOwnProperty(CACHE_KEY),
  currentStepIndex: 0,
  currentStep: {},
  tipStyles: {},
  placement: '',
  doneCountTime: 3
})

const isLast = computed(() => {
  return state.currentStepIndex === props.data.length - 1
})

const currentStepNum= computed(() => {
  return state.currentStepIndex + 1
})

/**
 * 窗口缩放
*/
const handleReize =_.throttle(function () {
  if (!state.isDone) {
    activeStep()
  }
}, 100)

/**
 * 指引初始化
*/
const init = () => {
  if (!state.isDone) {
    document.body.appendChild(wraperRef.value)
    activeStep()
  }
}

/**
        * 步骤切换时激活目标步骤
       */
const activeStep = () => {
  const windowWidth = window.innerWidth
  const windowHieght = window.innerHeight
  const currentStep: any = props.data[state.currentStepIndex]
  const $stepTarget = document.querySelector(currentStep.target)
  console.log($stepTarget, '$stepTarget$stepTarget', currentStep.target)
  $stepTarget.classList.add('guide-highlight')
  if (typeof state.currentStep.leave === 'function') {
    state.currentStep.leave()
  }
  if (typeof currentStep.entry === 'function') {
    currentStep.entry()
  }
  setTimeout(() => {
    const {
      top: targetTop,
      right: targetRight,
      bottom: targeBottom,
      left: targetLeft,
      width: targetWidth
    } = $stepTarget.getBoundingClientRect()
    const {
      width,
      height
    } = tipRef.value.getBoundingClientRect()

    let placement = 'left'
    if (width > height
      && targeBottom < 0.3 * windowHieght) {
      placement = targeBottom > 0.5 * windowHieght ? 'top' : 'bottom'
    } else {
      placement = targetLeft > 0.5 * windowWidth ? 'left' : 'right'
    }

    let styles = {}

    if (placement === 'bottom') {
      styles = {
        top: `${targeBottom + 10}px`,
        left: `${targetLeft + (targetWidth - width) / 2}px`
      }
    } else if (placement === 'top') {
      styles = {
        top: `${windowHieght - targetTop - height - 10}px`,
        left: `${targetLeft + (targetWidth - width) / 2}px`
      }
    } else if (placement === 'left') {
      styles = {
        top: `${targetTop}px`,
        right: `${windowWidth - targetLeft + 10}px`
      }
    } else if (placement === 'right') {
      styles = {
        top: `${targetTop}px`,
        left: `${targetRight + 10}px`
      }
    }
    state.currentStep = Object.freeze(currentStep)
    state.tipStyles = Object.freeze(styles)
    state.placement = placement
  })
}

/**
 * 取消跳过指引
*/
const handleCancelStop = () => {
  state.isShowStopDialog = false
  activeStep()
}

/**
 * 切换步骤
*/
const handleNext = () => {
  state.currentStepIndex++
  clearActive()
  activeStep()
}
/**
  * 清空所有步骤的激活状态
 */
const clearActive = () => {
  document.body.querySelectorAll('.guide-highlight').forEach(el => {
    el.classList.remove('guide-highlight')
  })
}

/**
 * 跳过指引确认操作
*/
const handleStop = () => {
  state.isShowStopDialog = true
  clearActive()
}

/**
 * 结束指引确认操作
*/
const handleFinish = () => {
  clearActive()
  state.isShowFinisheDialog = true
  const countdown = () => {
    setTimeout(() => {
      state.doneCountTime--
      if (state.doneCountTime > 0) {
        countdown()
      } else {
        doneGudie()
      }
    }, 1000)
  }
  countdown()
}

/**
      * 完成指引
     */
const doneGudie = () => {
  const now: string = (Date.now() as any);
  document.cookie = cookie.serialize(CACHE_KEY, now, {
    expires: new Date(Date.now() + 31104000000),
    path: '/'
  })
  state.isDone = true
  if (state.currentStep && typeof state.currentStep.leave === 'function') {
    state.currentStep.leave()
  }
  setTimeout(() => {
    wraperRef.value && wraperRef.value.parentNode.removeChild(wraperRef.value)
  })
}

const handleDone = () => {
  doneGudie()
}

onMounted(() => {
  init()
})

// onBeforeDestroy(() => {
//   clearActive()
//   wraperRef.value && wraperRef.value.parentNode.removeChild(wraperRef.value)
//   window.removeEventListener('resize', handleReize)
// })
</script>

<template>
  <transition name="guide-fade">
      <div v-if="!state.isDone" ref="wraperRef" class="novice-guide">
        <div
            v-if="!state.isShowFinisheDialog && !state.isShowStopDialog"
            ref="tipRef"
            class="step-box"
            :class="state.placement"
            :style="state.tipStyles">
            <div class="step-title">{{ state.currentStep.title }}（{{ currentStepNum }}/{{ data.length }}）</div>
            <div class="step-content">{{ state.currentStep.content }}</div>
            <div class="step-action">
                <template v-if="!isLast">
                    <div class="action-text" @click="handleStop">跳过</div>
                    <div class="action-btn" @click="handleNext">下一步</div>
                </template>
                <div v-else class="action-btn" @click="handleFinish">完成</div>
            </div>
            <div class="target-arrow"></div>
        </div>
        <div v-if="state.isShowFinisheDialog" class="guide-finished-box">
            <div class="wraper">
                <div class="flag">
                    <i class="bk-icon icon-check-1" />
                </div>
                <div style="font-size: 24px; line-height: 31px; color: #313238">恭喜完成学习!</div>
                <div style="margin-top: 8px; font-size: 14px; line-height: 19px; color: #979BA5">{{ state.doneCountTime }} 秒后弹窗自动消失</div>
                <div style="margin-top: 20px">
                    <span style="font-size: 14px; line-height: 19px; color: #3480FF; cursor: pointer" @click="handleDone">立即体验</span>
                </div>
            </div>
        </div>
        <div v-if="state.isShowStopDialog" class="guide-stop-box">
            <div class="wraper">
                <div style="font-size: 24px; line-height: 31px; color: #313238">确认跳过学习？</div>
                <div style="margin-top: 27px; font-size: 14px; line-height: 19px; color: #63656E">跳过此次学习，你可点击页面右上角的帮助指引，再次发起学习。</div>
                <div style="margin-top: 22px;">
                    <img :src="helpImg" style="width: 157px; height: 157px" />
                </div>
                <div style="margin-top: 27px">
                  <bk-button theme="primary" class="mr10" @click="handleDone">确定</bk-button>
                  <bk-button @click="handleCancelStop">取消</bk-button>
                </div>
                <!-- <div class="cancal-btn" @click="handleCancelStop">
                    <i class="bk-icon icon-close" />
                </div> -->
            </div>
        </div>
      </div>
  </transition>
</template>

<style lang='scss' scoped>
  body{
      *.guide-highlight{
          opacity: 1 !important;
          z-index: 100001 !important;
          background: #fff;
          pointer-events: none !important;
      }
  }
  .novice-guide{
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      z-index: 100000;
      background: rgba(0,0,0,0.6);
      .step-box{
          position: absolute;
          width: 270px;
          min-height: 110px;
          padding: 12px 10px 10px;
          font-size: 12px;
          color: #313238;
          border-radius: 2px;
          background: #fff;
          &.right{
              .target-arrow{
                  top: 30px;
                  left: -4px;
              }
          }
          &.left{
              .target-arrow{
                  top: 30px;
                  right: -4px;
              }
          }
          &.bottom{
              .target-arrow{
                  top: -4px;
                  left: 50%;
              }
          }
          &.top{
              .target-arrow{
                  bottom: -4px;
                  left: 50%;
              }
          }
          .step-title{
              font-weight: bold;
              line-height: 16px;
          }
          .step-content{
              margin-top: 7px;
          }
          .step-action{
              display: flex;
              justify-content: flex-end;
              margin-top: 14px;
              .action-text{
                  color: #3A84FF;
                  cursor: pointer;
              }
              .action-btn{
                  height: 20px;
                  padding: 0 8px;
                  margin-left: 14px;
                  line-height: 20px;
                  color: #fff;
                  border-radius: 10px;
                  background: #3A84FF;
                  cursor: pointer;
              }
          }
          .target-arrow{
              position: absolute;
              width: 8px;
              height: 8px;
              background: inherit;
              transform: rotateZ(45deg);
          }
      }
      .guide-finished-box{
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          .wraper{
              width: 400px;
              height: 210px;
              padding-top: 74px;
              text-align: center;
              background: #fff;
              border-radius: 2px;
              .flag{
                  position: absolute;
                  top: 0;
                  left: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  width: 86px;
                  height: 86px;
                  font-size: 55px;
                  color: #fff;
                  border: 13px solid #DCFFE2;
                  border-radius: 50%;
                  background: #2DCB56;
                  transform: translate(-50%, -27px);
                  &:after{
                      content: '';
                      position: absolute;
                  }
              }
          }
      }
      .guide-stop-box{
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          .wraper{
              width: 500px;
              /* height: 390px; */
              /* padding-top: 45px; */
              height: 370px;
              padding-top: 25px;
              text-align: center;
              border-radius: 2px;
              background: #fff;
              .cancal-btn{
                  position: absolute;
                  top: 5px;
                  right: 5px;
                  width: 26px;
                  height: 26px;
                  font-weight: 700;
                  font-size: 22px;
                  color: #979ba5;
                  line-height: 26px;
                  text-align: center;
                  border-radius: 50%;
                  cursor: pointer;
                  &:hover{
                      background-color: #f0f1f5;
                  }
              }
          }
      }
  }
  .guide-fade-leave-active{
      transition: visibility .15s linear, opacity .1s linear;
  }
  .guide-fade-leave-to{
      opacity: 0;
      visibility: hidden;
  }
</style>